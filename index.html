<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        /* Styles wie gehabt, nichts ge√§ndert */
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-dark-red: #8b0000; --bosch-work-yellow: #fff3cd; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; padding: 20px; flex: 1; overflow: hidden; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.2em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: inherit; cursor: pointer; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .card { padding: 12px; border-bottom: 1px solid #eee; border-left: 8px solid #ccc; margin-bottom: 8px; background: #fff; }
        .card.warning { border-left-color: #ffa500; } .card.critical { border-left-color: var(--bosch-red); } .card.overdue { border-left-color: var(--bosch-dark-red); } .card.in-progress { background: var(--bosch-work-yellow) !important; border-left-style: dashed; }
        @keyframes blink-red { 0% { background: #fff; } 50% { background: #ffcccc; } 100% { background: #fff; } } .blink { animation: blink-red 1s infinite; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .m-id { font-weight: bold; font-size: 1.1em; } .m-rest { font-weight: bold; font-size: 1.1em; } .m-paket { font-size: 0.85em; color: var(--bosch-red); font-weight: bold; margin-top: 2px; } .m-time { font-size: 0.8em; color: #666; font-style: italic; }
        select { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 2px; margin-top: 8px; }
        .nav-btn { padding: 8px 15px; cursor: pointer; border: 1px solid #ccc; background: white; font-weight: bold; color: var(--bosch-blue); border-radius: 2px; }
        .btn-primary { background: var(--bosch-blue); color: white; border: none; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal-box { background: white; padding: 30px; border-top: 8px solid var(--bosch-red); width: 450px; border-radius: 4px; }
        #timeout-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #ddd; } #timeout-bar { height: 100%; width: 0%; background: var(--bosch-red); }
    </style>
</head>
<body onmousedown="resetInactivityTimer()" onkeydown="resetInactivityTimer()">

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>
<div class="header">
    <div><span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> <span style="font-weight:bold;margin-left:10px;color:#555;">Status√ºbersicht</span></div>
    <div style="display:flex; gap:10px;">
        <button class="nav-btn" onclick="document.getElementById('helpModal').style.display='flex'">‚ÑπÔ∏è Hilfe</button>
        <button id="authBtn" class="nav-btn" onclick="handleLoginClick()">üîë Login</button>
        <button class="nav-btn" onclick="openAdminModal()">‚öôÔ∏è Einsteller</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="column"><div class="col-header"><a onclick="window.open('https://norman8410.github.io/Wartungs-Dashboard-W430V3/agie.html','_blank')">‚ö° Agie ‚ûî</a> <span id="count-agie">0</span></div><div class="machine-list" id="list-agie"></div></div>
    <div class="column" style="border-top-color: var(--bosch-green);"><div class="col-header"><a onclick="window.open('https://norman8410.github.io/Wartungs-Dashboard-W430V3/unotron.html','_blank')">üß™ Unotron ‚ûî</a> <span id="count-uno">0</span></div><div class="machine-list" id="list-uno"></div></div>
    <div class="column" style="border-top-color: var(--bosch-light-blue);"><div class="col-header"><a onclick="window.open('https://norman8410.github.io/Wartungs-Dashboard-W430V3/he.html','_blank')">‚öôÔ∏è HE ‚ûî</a> <span id="count-he">0</span></div><div class="machine-list" id="list-he"></div></div>
</div>

<div id="timeout-bar-container"><div id="timeout-bar"></div></div>

<div id="loginModal" class="modal">... (Inhalt Login wie vorher) ...</div> 
<div id="adminModal" class="modal">... (Inhalt Admin wie vorher) ...</div>
<div id="helpModal" class="modal"><div class="modal-box">
    <h2 style="color:var(--bosch-blue); border-bottom: 2px solid var(--bosch-red); padding-bottom: 10px;">System-Hilfe</h2>
    <p><strong>Auto-Logout:</strong> Erfolgt nach 70s Inaktivit√§t.</p>
    <p>Den Einladungscode erhalten Sie von Ihrem TL, FK oder Admin.</p>
    <p><strong>Verantwortlich: Norman Schultheis</strong></p>
    <button class="nav-btn btn-primary" style="width:100%; margin-top:20px;" onclick="closeModals()">Schlie√üen</button>
</div></div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), auth = firebase.auth();

    // Dynamische Berechnung aus Config
    function getDuration(pkgString, timeTable) {
        if (!pkgString || pkgString.includes("AUSTAUSCH") || !timeTable) return 0;
        return pkgString.split('/').reduce((acc, p) => {
             let key = p.toUpperCase(); if(!key.startsWith("P")) key = "P"+key;
             return acc + (timeTable[key] || 0);
        }, 0);
    }

    let state = { config:{}, assignments:{}, agie:{}, uno:{}, he:{}, maintConfig: {} };
    let inactivityTimer, startTime, isReg=false;

    // Login/Timer/UI Hooks wie gehabt (gek√ºrzt f√ºr √úbersicht)
    window.resetInactivityTimer = function() { ... }
    function updateBar() { ... }
    function handleLoginClick() { ... }
    function closeModals() { ... }
    function toggleM() { ... }
    async function handleAuthAction() { ... }
    function openAdminModal() { ... }
    async function saveEinstellerList() { ... }
    async function safeSave(key, val) { ... }

    // DATA LOADING
    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });
    db.ref('dashboardAssignments').on('value', s => { state.assignments = s.val() || {}; updateUI(); });
    db.ref('config').on('value', s => { state.config = s.val() || {}; updateUI(); });

    auth.onAuthStateChanged(user => { 
        document.getElementById('authBtn').innerText = user ? "üîì Logout" : "üîë Login";
        if(user) resetInactivityTimer(); else { clearTimeout(inactivityTimer); document.getElementById('timeout-bar').style.width="0%"; }
        updateUI();
    });

    function updateUI() {
        if(!state.maintConfig.agie) return; // Warten auf Config
        renderCol('list-agie', 'count-agie', state.agie, 'A', state.maintConfig.agie);
        renderCol('list-uno', 'count-uno', state.uno, 'U', state.maintConfig.unotron);
        renderCol('list-he', 'count-he', state.he, 'H', state.maintConfig.he);
    }

    function renderCol(id, cId, raw, pre, cfg) {
        if(!raw || !raw.cloudRawData || !cfg) return;
        
        const data = raw.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO;
            if(!sId) return null;
            const cIdx = (raw.extraCycles && raw.extraCycles[sId]) || 0;
            const offKey = pre==='A'?'agieOffsets':(pre==='H'?'heOffsets':''); // Unotron hat kein Offset im alten Code, ggf anpassen wenn n√∂tig
            const off = (raw[offKey] && raw[offKey][sId]) || 0;
            const ist = (parseInt(item.Parts||item["COUNT(*)"])||0) - off;
            
            const step = cfg.steps[cIdx] || { target: cfg.maxLimit, pkg: "AUSTAUSCH" };
            const isOverMax = ist >= cfg.maxLimit;
            let target = isOverMax ? cfg.maxLimit : step.target;
            let pkgName = isOverMax ? "WP RESET" : step.pkg;

            const duration = getDuration(pkgName, cfg.times);
            return { id:pre+"-"+sId, rest: target-ist, key:pre+sId, pkg: pkgName, duration, warn: cfg.warn, crit: cfg.crit };
        }).filter(m => m && m.rest < m.warn).sort((a,b) => a.rest - b.rest);

        document.getElementById(cId).innerText = data.length;
        document.getElementById(id).innerHTML = data.map(m => {
            const assigned = state.assignments[m.key] || "";
            const isWorking = assigned !== "";
            const status = (m.rest <= 0 && !isWorking) ? 'blink overdue' : (m.rest <= 0 ? 'overdue' : (m.rest < m.crit ? 'critical' : 'warning'));
            return `
            <div class="card ${status} ${isWorking?'in-progress':''}">
                <div class="card-info">
                    <div>
                        <div class="m-id">${m.id}</div>
                        <div class="m-paket">${m.pkg}</div>
                        ${m.duration > 0 ? `<div class="m-time">‚è± ca. ${m.duration} Min.</div>` : ''}
                    </div>
                    <div class="m-rest">${m.rest.toLocaleString()}</div>
                </div>
                <select ${!auth.currentUser?'disabled':''} onchange="safeSave('${m.key}', this.value)">
                    <option value="">-- Einsteller w√§hlen --</option>
                    ${(state.config.einstellerListe||[]).map(e => `<option value="${e}" ${assigned===e?'selected':''}>${e}</option>`).join('')}
                </select>
            </div>`;
        }).join('');
    }
</script>
</body>
</html>
