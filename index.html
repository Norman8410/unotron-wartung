<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Zentrales Wartungs Dashboard W430</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #003a6c 50%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-workload { background: var(--bosch-blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.1em; margin-left: 20px;}
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 20px; flex: 1; overflow-y: auto; }
        .column { background: white; border-top: 5px solid var(--bosch-blue); display: flex; flex-direction: column; overflow: hidden; border-radius: 4px; min-height: 400px; }
        .col-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center; }
        .col-header a { text-decoration: none; color: var(--bosch-blue); display: flex; align-items: center; gap: 5px; }
        .col-header a:hover { color: var(--bosch-red); }
        .time-badge { font-size: 0.8em; color: var(--bosch-red); background: #fff; padding: 2px 8px; border-radius: 12px; border: 1px solid #ffcccc; }
        .machine-list { flex: 1; overflow-y: auto; padding: 10px; }
        .no-data { text-align: center; color: #999; padding-top: 50px; font-style: italic; }
        .card { padding: 12px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #eee; }
        .card.warning { background-color: #fff3cd; border-left: 8px solid #ffc107; }
        .card.critical { background-color: #f8d7da; border-left: 8px solid #dc3545; }
        .card.overdue { background-color: #f5b7b1; border-left: 8px solid #b03a2e; }
        .card-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .m-id { font-weight: bold; font-size: 1.2em; } .m-rest { font-weight: bold; font-size: 1.2em; } .m-paket { font-size: 0.9em; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">Zentrales Wartungs Dashboard W430</div>
<div class="header">
    <div style="display:flex; align-items:center;">
        <span style="color:var(--bosch-red);font-weight:900;font-size:24px;">BOSCH</span> 
        <div id="overall-workload" class="total-workload">Lade...</div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Bestehende Spalten mit korrekten Links -->
    <div class="column"><div class="col-header"><a href="agie.html" target="_blank">‚ö° Agie <span>‚ûî</span></a><div id="count-agie">0</div></div><div class="machine-list" id="list-agie"></div></div>
    <div class="column"><div class="col-header"><a href="unotron.html" target="_blank">üß™ Unotron <span>‚ûî</span></a><div id="count-uno">0</div></div><div class="machine-list" id="list-uno"></div></div>
    <div class="column"><div class="col-header"><a href="he.html" target="_blank">‚öôÔ∏è HE <span>‚ûî</span></a><div id="count-he">0</div></div><div class="machine-list" id="list-he"></div></div>
    <div class="column"><div class="col-header"><a href="unotron-auto.html" target="_blank">ü§ñ Unotron Auto <span>‚ûî</span></a><div id="count-uno-auto">0</div></div><div class="machine-list" id="list-uno-auto"></div></div>
    <div class="column"><div class="col-header"><a href="laser.html" target="_blank">üí° Laser <span>‚ûî</span></a><div id="count-laser">0</div></div><div class="machine-list" id="list-laser"></div></div>
    
    <!-- Neue gruppierte Spalten mit Links -->
    <div class="column" style="border-top-color: #17a2b8;"><div class="col-header"><a href="waschanlagen.html" target="_blank">üíß Waschanlagen <span>‚ûî</span></a><div id="count-wasch">0</div></div><div class="machine-list" id="list-wasch"></div></div>
    <div class="column" style="border-top-color: #fd7e14;"><div class="col-header"><a href="pruefgeraete.html" target="_blank">üîç Pr√ºfger√§te <span>‚ûî</span></a><div id="count-pruef">0</div></div><div class="machine-list" id="list-pruef"></div></div>
    <div class="column" style="border-top-color: #6f42c1;"><div class="col-header"><a href="lager.html" target="_blank">üì¶ Lager & Regale <span>‚ûî</span></a><div id="count-lager">0</div></div><div class="machine-list" id="list-lager"></div></div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg", authDomain: "bosch-agie-wartung.firebaseapp.com", databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app", projectId: "bosch-agie-wartung" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let state = { maintConfig: {}, agie: {}, uno: {}, he: {}, unoAuto: {}, laser: {}, kw_states: {} };

    // Definition der neuen Gruppen (Firebase-Keys zuordnen)
    const kwGroups = {
        wasch: ['silberhorn', 'ministar'],
        pruef: ['sichtpruefstaende', 'sichtpruefplaetze', 'einstellgeraetNek'],
        lager: ['unotronAblieferregal', 'entkopplungsregal', 'waschregal', 'oellager']
    };

    // --- DATEN-LISTENER ---
    db.ref('maintenanceConfig').on('value', s => { state.maintConfig = s.val() || {}; updateUI(); });
    db.ref('maintenanceState').on('value', s => { state.agie = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotron').on('value', s => { state.uno = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateHE').on('value', s => { state.he = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateUnotronAuto').on('value', s => { state.unoAuto = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateLaser').on('value', s => { state.laser = s.val() || {}; updateUI(); });
    db.ref('maintenanceStateKW').on('value', s => { state.kw_states = s.val() || {}; updateUI(); });

    // --- HILFSFUNKTIONEN ---
    function getDuration(p, t) { if(!p||p.includes("RESET")||!t)return 0; return p.split(/[\s\/]+/).reduce((a,c)=>{let k=c.toUpperCase().trim(); if(k&&!k.startsWith("P"))k="P"+k; return a+(t[k]||0);},0); }
    function formatTime(m){ if(m<=0)return"0m"; const d=Math.floor(m/1440),h=Math.floor((m%1440)/60),min=m%60; let p=[]; if(d>0)p.push(d+'d'); if(h>0)p.push(h+'h'); if(min>0||p.length===0)p.push(min+'m'); return p.join(' '); }
    function getWeek() { const d=new Date(); d.setHours(0,0,0,0); d.setDate(d.getDate()+3-(d.getDay()+6)%7); const w1=new Date(d.getFullYear(),0,4); return 1+Math.round(((d-w1)/86400000-3+(w1.getDay()+6)%7)/7); }

    function renderCard(m) {
        let cls = 'warning'; if (m.rest <= 0) cls = 'overdue'; else if (m.rest <= m.crit) cls = 'critical';
        const restUnit = m.unit === 'W' ? ' Wo' : '';
        return `<div class="card ${cls}"><div class="card-info"><div><div class="m-id">${m.id}</div><div class="m-paket">${m.pkg}</div><div style="font-size:0.9em;color:#555">‚è± ${m.dur} Min.</div></div><div class="m-rest">${m.rest.toLocaleString()}${restUnit}</div></div></div>`;
    }

    // --- RENDER-FUNKTIONEN ---
    function renderCol(listId, countId, raw, prefix, cfg) {
        let totalMin = 0;
        if(!raw || !raw.cloudRawData || !cfg) {
            document.getElementById(listId).innerHTML = '<div class="no-data">Lade Daten...</div>';
            document.getElementById(countId).innerHTML = '0';
            return 0;
        }
        
        const data = raw.cloudRawData.map(item => {
            const sId = item.StationNo || item.STATIONNO; if(!sId) return null;
            const stand = parseInt(item.Parts || item["COUNT(*)"]) || 0;
            const offK = prefix==='A-'?'agieOffsets':(prefix==='H-'?'heOffsets':(prefix==='L-'?'laserOffsets':'unotronOffsets'));
            const offset = (raw[offK] && raw[offK][sId]) || 0;
            const cyc = (raw.extraCycles && raw.extraCycles[sId]) || 0;
            const ist = stand - offset;
            const step = (cfg.steps && cfg.steps[cyc]) || { target: cfg.maxLimit, pkg: "RESET" };
            const isOver = ist >= cfg.maxLimit;
            const target = isOver ? cfg.maxLimit : step.target;
            const rest = target - ist;
            if (rest > cfg.warn) return null;
            const dur = getDuration(isOver ? "RESET" : step.pkg, cfg.times);
            totalMin += dur;
            return { id: prefix + sId, rest, pkg: isOver ? "WP RESET" : step.pkg, dur, crit: cfg.crit, unit: 'Stk' };
        }).filter(m => m).sort((a,b) => a.rest - b.rest);

        let cardsHtml = data.length > 0 ? data.map(renderCard).join('') : '<div class="no-data">Keine anstehenden Wartungen</div>';
        
        const badge = totalMin > 0 ? `<span class="time-badge">‚è≥ ${formatTime(totalMin)}</span>` : "";
        document.getElementById(countId).innerHTML = `<span>${data.length}</span> ${badge}`;
        document.getElementById(listId).innerHTML = cardsHtml;
        return totalMin;
    }

    function renderColKw(listId, countId, groupKeys) {
        let allMachines = [];
        let totalMin = 0;
        const currentWeek = getWeek();

        groupKeys.forEach(key => {
            const cfg = state.maintConfig[key];
            const machineState = state.kw_states[key];
            if (!cfg || !machineState) return;

            const cycles = machineState.extraCycles || {};
            const machineIds = cfg.machines || [];

            machineIds.forEach(id => {
                const cyc = cycles[id] || 0;
                const step = (cfg.steps && cfg.steps.length > cyc) ? cfg.steps[cyc] : { target: cfg.yearlyResetWeek || 52, pkg: "JAHRES-RESET" };
                const isReset = !(cfg.steps && cfg.steps.length > cyc);
                const targetWeek = step.target;
                const rest = targetWeek - currentWeek;
                
                if (rest <= (cfg.warnWeeks || 4)) {
                    const dur = getDuration(isReset ? "JAHRES-RESET" : step.pkg, cfg.times);
                    totalMin += dur;
                    allMachines.push({ id: (cfg.prefix || key.substring(0,1).toUpperCase()+'-') + id, rest, pkg: step.pkg, dur, crit: 0, unit: 'W' });
                }
            });
        });

        allMachines.sort((a,b) => a.rest - b.rest);
        
        let cardsHtml = allMachines.length > 0 ? allMachines.map(renderCard).join('') : '<div class="no-data">Keine anstehenden Wartungen</div>';
        const badge = totalMin > 0 ? `<span class="time-badge">‚è≥ ${formatTime(totalMin)}</span>` : "";
        
        document.getElementById(countId).innerHTML = `<span>${allMachines.length}</span> ${badge}`;
        document.getElementById(listId).innerHTML = cardsHtml;
        return totalMin;
    }

    // --- HAUPTFUNKTION ---
    function updateUI() {
        if (!state.maintConfig.agie || !state.maintConfig.unotron) return;

        let globalTotalMin = 0;
        globalTotalMin += renderCol('list-agie', 'count-agie', state.agie, 'A-', state.maintConfig.agie);
        globalTotalMin += renderCol('list-uno', 'count-uno', state.uno, 'U-', state.maintConfig.unotron);
        globalTotalMin += renderCol('list-he', 'count-he', state.he, 'H-', state.maintConfig.he);
        globalTotalMin += renderCol('list-laser', 'count-laser', state.laser, 'L-', state.maintConfig.laser);
        
        if (state.uno && state.uno.cloudRawData && state.maintConfig.unotronAuto) {
            const unoGroups = { "100": [101,102,103,104,113,114,115,116], "200": [117,112,111,110,109,108,107,106], "300": [118,119,120,121,122,123,124,125] };
            const autoRawList = Object.keys(unoGroups).map(groupId => ({ StationNo: groupId, Parts: unoGroups[groupId].reduce((acc, sId) => acc + ((state.uno.cloudRawData.find(r => r.STATIONNO == sId) || {})["COUNT(*)"] || 0), 0) }));
            globalTotalMin += renderCol('list-uno-auto', 'count-uno-auto', { ...state.unoAuto, cloudRawData: autoRawList }, 'UA-', state.maintConfig.unotronAuto);
        }

        globalTotalMin += renderColKw('list-wasch', 'count-wasch', kwGroups.wasch);
        globalTotalMin += renderColKw('list-pruef', 'count-pruef', kwGroups.pruef);
        globalTotalMin += renderColKw('list-lager', 'count-lager', kwGroups.lager);
        
        document.getElementById('overall-workload').innerText = `Gesamtaufwand: ${formatTime(globalTotalMin)}`;
    }
</script>

</body>
</html>
